<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web Calculator</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <style>
    .to-center {
      width: 275px;
      height: auto;
      text-align: right;        
    }
    .calc-buttons {
      width: 255px;
      height: auto;
      text-align: center;
    }
    #calculator-container {
      width: 255px;
      height: auto;
      text-align: center;
      float:left;
    }
    #history-container {
      width: 680px;
      height: auto;
      text-align: center;
      float:right;
      overflow: auto;
    }
    #all-content {
    width:1000px;
    text-align:center;
}
  </style>
</head>
<body onkeypress="evaluateKeyPressed(event)">
<!-- Latest compiled and minified JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script>

      var SITE_URL = 'http://webmathcalculator.herokuapp.com/webcalculator';
      //var SITE_URL = 'http://localhost:8080/webcalculator';

      function retrieveSessionToken() {
        var q = $.Deferred();
        var jqxhr = $.post( SITE_URL + '/token', function(response) {
            result = response.body.token;
            q.resolve(result);
        }).fail( function (msg) {
            window.alert("token retrieval failed");
            result = "defaultToken";
            q.resolve(result);
        });
        return q.promise();
      }
      
      var token = ""; 
      var lastButtonEqual = false;
      var lastButtonOperator = false;
      var OPERATORS = ['+', '*', '/', '-'];
      var VALID_KEYS = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '+', '*', '/', '-'];
      var ENTER_KEY = 'Enter';
      
      function trimLeadingZero() {
        lastButtonEqual = false;
        var expressionField = $('#expression')[0];
        var expressionText = expressionField.value;
        if (expressionText.length > 1 && (expressionText.charAt(0) === '0' || expressionText.charAt(0) === '0.0')) {
           expressionField.value = expressionText.substr(1, expressionText.length);
        }
      }
      
      function append(s) {
        lastButtonOperator = OPERATORS.indexOf(s) >= 0;
        var expressionField = $('#expression')[0];
        if (lastButtonEqual) {
          expressionField.value = lastButtonOperator ? expressionField.value + ' ' + s + ' ' : s;
        } else {
          expressionField.value = expressionField.value + (lastButtonOperator ? ' ' + s + ' ' : s);
        }
        trimLeadingZero();
      }

      function updateHistory(historyComponent) {
        $.get(encodeURI(SITE_URL + '/history?token=' + token), function(historyResponse) {
          historyComponent.text('');
          historyComponent.append(historyResponse.body.tableHTML);
        }).fail( function () {
          window.alert("failed retrieving history");
        });
      }
      
      function calculate() { 
        lastButtonEqual = true;
        var expressionField = $('#expression')[0];
        var expressionText = encodeURIComponent(expressionField.value);
        if (token.length > 0) {
          $.post( encodeURI(SITE_URL + '?token=' + token + '&expression=' + expressionText), function(calculationResponse) {
            expressionField.value = calculationResponse.body.result;
            updateHistory($('#history-container'));
            }).fail( function () {
                window.alert("fail calculation");
            });
        } else {
          retrieveSessionToken().then(function(resultToken) {   
            token = resultToken;
            $.post( encodeURI(SITE_URL + '?token=' + resultToken + '&expression=' + expressionText), function(calculationResponse) {
            expressionField.value = calculationResponse.body.result;
            updateHistory($('#history-container'));
            }).fail( function () {
                window.alert("fail calculation");
            });
          });
        }
      }
      
      function clearResult() {
        var expressionField = $('#expression')[0];
        expressionField.value = 0;
      }
      
      function displayHistory() {
          if (token.length > 0) {
            var historyComponent = $('#history-container');
            if (historyComponent[0].style.display === 'none') {
              historyComponent[0].style.display = 'block'
            } else {
              historyComponent[0].style.display = 'none'
            }
          }
      }
      
      function removeLastCharacter() {        
        var expressionField = $('#expression')[0];
        if (expressionField.value.length > 1) {
          expressionField.value = expressionField.value.substr(0, expressionField.value.length - 1);
        } else {
          expressionField.value = '0';
        }
      }

      function evaluateKeyPressed(e) {
        var key = e.key;
        if (VALID_KEYS.indexOf(key) >= 0) {
          append(key);
        } else if (key === ENTER_KEY) {
          calculate();
        }
      }
      
    </script>
  <div class="panel panel-default">
  <div class="panel-body">
    <div id="all-content">
      <div id="calculator-container">      
        <div class="input-group input-group-lg to-center">
            <span class="input-group-addon" id="basic-addon1"></span>
            <input  data-toggle="tooltip" title="eval($('#expression')[0].value)" type="text" id="expression" name="expression" class="form-control" placeholder="" aria-describedby="basic-addon1" value="0" style="text-align:right;" readonly />
          <div class="calc-buttons">
            <div class="btn-group btn-group-lg">
              <button type="button" class="btn btn-primary" onclick="clearResult()">Clear</button>
              <button type="button" class="btn btn-primary" onclick="displayHistory()">History</button>
              <button type="button" class="btn btn-primary" onclick="removeLastCharacter()"><span class="glyphicon glyphicon-arrow-left"></span></button>
            </div>
            <div class="btn-group btn-group-lg">
              <button type="button" class="btn btn-primary" onclick="append('7')">7</button>
              <button type="button" class="btn btn-primary" onclick="append('8')">8</button>
              <button type="button" class="btn btn-primary" onclick="append('9')">9</button>
              <button type="button" class="btn btn-primary" onclick="append('+')">+</button>
              <button type="button" class="btn btn-primary" onclick="append('[')">[</button>
              <button type="button" class="btn btn-primary" onclick="append(']')">]</button>
            </div>
            <div class="btn-group btn-group-lg">
              <button type="button" class="btn btn-primary" onclick="append('4')">4</button>
              <button type="button" class="btn btn-primary" onclick="append('5')">5</button>
              <button type="button" class="btn btn-primary" onclick="append('6')">6</button>
              <button type="button" class="btn btn-primary" onclick="append('-')">-</button>
              <button type="button" class="btn btn-primary" onclick="append('(')">(</button>
              <button type="button" class="btn btn-primary" onclick="append(')')">)</button>
            </div>
            <div class="btn-group btn-group-lg">
              <button type="button" class="btn btn-primary" onclick="append('1')">1</button>
              <button type="button" class="btn btn-primary" onclick="append('2')">2</button>
              <button type="button" class="btn btn-primary" onclick="append('3')">3</button>
              <button type="button" class="btn btn-primary" onclick="append('*')">*</button>
              <button type="button" class="btn btn-primary" onclick="append('{')">{</button>
              <button type="button" class="btn btn-primary" onclick="append('}')">}</button>
            </div>
            <div class="btn-group btn-group-lg">
              <button type="button" class="btn btn-primary" onclick="append('0')">0</button>
              <button type="button" class="btn btn-primary" onclick="append('.')">.</button>
              <button type="button" class="btn btn-primary" onclick="calculate()">=</button>
              <button type="button" class="btn btn-primary" onclick="append('/')">/</button>
              <button type="button" class="btn btn-primary" onclick="append('sqrt(')">sqrt</button>
            </div>
          </div>
        </div> 
      </div>      
      <div id="history-container" style="display: none"></div>
    </div>   
  </div>
  <div class="panel-footer">web calculator 1.0</div>
</div>
</body>
</html>