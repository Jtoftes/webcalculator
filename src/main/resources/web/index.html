<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web Calculator</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <style>
        .to-center {
            width: 275px;
            height: auto;
            text-align: right;
        }

        .calc-buttons {
            width: 255px;
            height: auto;
            text-align: center;
        }

        #calculator-container {
            width: 255px;
            height: auto;
            text-align: center;
            float: left;
        }

        #history-container {
            width: 680px;
            height: 274px;
            text-align: center;
            float: right;
            overflow: auto;
        }

        #all-content {
            width: 1200px;
            text-align: center;
        }

        .operation-container {
            align-content: center;
        }

        .error-messages {
            float: left;
            width: 95%;
            text-align: center;
        }

        thead th {
            text-align: center;
        }
        button {
            cursor: pointer;
        }

    </style>
</head>
<body onkeypress="evaluateKeyPressed(event)">
<!-- Latest compiled and minified JavaScript -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>
<script>

    var SQRT_SYMBOL = 'sqrt (';
    var MINUS_SYMBOL = '-';
    var OPERATORS = ['+', '*', '/', MINUS_SYMBOL, '[', ']', '{', '}', '(', ')', SQRT_SYMBOL];
    var sqrtIndex = OPERATORS.indexOf(SQRT_SYMBOL);
    var minusIndex = OPERATORS.indexOf(MINUS_SYMBOL);
    var VALID_CODES = [40, 41, 42, 43, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 91, 93, 123, 125];
    var VALID_KEYS = ['(', ')', '*', '+', MINUS_SYMBOL, '.', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '[', ']', '{', '}'];
    var AVAILABLE_FUNCTIONS = ['e^x'];
    var ENTER_KEY = 'Enter';
    var ERROR_RESULTS = ['INFINITY', 'NAN', '-INFINITY'];
    var ENTER_CODE = 13;
    var ESC_KEY = 27;

    var token = "";
    var lastButtonEqual = true;
    var lastButtonOperator = false;
    var activePanel = 0;
    var panels = [];
    var errorContainer = null;
    var ERROR_FADE_TIME = 8000;
    var allowInteractions = true;
    var integralSubmit = null;
    var expressionField = null;
    var integralSelectedFunction = 0;
    var inputStackSizes = [];

    var STACK_ADD = 0;
    var STACK_REMOVE = 1;
    var STACK_EMPTY = 2;

    function operateStack(operation, num) {
        if (operation === STACK_ADD) {
            inputStackSizes.push(num);
            return 0;
        } else if (operation === STACK_REMOVE) {
            return inputStackSizes.pop();
        } else if (operation === STACK_EMPTY) {
            inputStackSizes.length = 0;
            return -1;
        }
        return -2;
    }

    function initIntegralSubmit() {
        if (integralSubmit === null) {
            integralSubmit = $('#sendintegral');
        }
    }

    function initExpressionField() {
        if (expressionField === null) {
            expressionField = $('#expression')[0];
        }
    }
    function buildAndAppendErrorDiv(errorContainer, errorMessage) {
        var rand = Math.random() + '';
        var newErrorId =  "error_" + rand.substr(rand.length - 5);
        errorContainer.append('<div class="alert alert-danger ' + newErrorId + '" role="alert" id="' +  newErrorId + '"><b>Error: </b>' + errorMessage + '</div>');
        return newErrorId;
    }

    function displayError(errorMessage) {
        if (errorContainer === null) {
            errorContainer = $('#error_messages');
        }
        var newErrorId = buildAndAppendErrorDiv(errorContainer, errorMessage);
        $('#' + newErrorId).fadeOut(ERROR_FADE_TIME, function () {
            $('div').remove('.' + newErrorId);
        });
    }

    function retrieveSessionToken() {
        var q = $.Deferred();
        $.post('/token'
        ).done(function (response) {
            result = response.body.token;
            q.resolve(result);
        }).fail(function (failedResponse) {
            displayError("No connection with the server");
            q.reject();
        });
        return q.promise();
    }

    function blurIfAvailable(comp) {
        try {
            if (comp && !comp.hasOwnProperty('blur')) {
                $('#' + comp).blur();
            }
        } catch(e) {
            console.log(e);
        }
    }

    function append(comp, s, override) {
        var consecutiveDots = function (value) {
            var split = value.split(' ');
            for (var i = 0; i < split.length; i++) {
                if (split[i].indexOf('..') >= 0) {
                    return true;
                }
            }
            return false;
        };
        if (allowInteractions || override) {
            var opIndex = OPERATORS.indexOf(s);
            lastButtonOperator = opIndex >= 0;
            initExpressionField();
            var lastAddedValue = null;
            expressionField.value = ERROR_RESULTS.indexOf(expressionField.value.toUpperCase()) >= 0 ? '0' : expressionField.value;
            if (lastButtonEqual) {
                if (lastButtonOperator) {
                    var binaryOperator = opIndex !== sqrtIndex;
                    if (binaryOperator) {
                        lastAddedValue = ' ' + s + ' ';
                        expressionField.value = expressionField.value + lastAddedValue;
                    } else {
                        lastAddedValue = s + ' ';
                        expressionField.value = lastAddedValue;
                    }
                } else {
                    lastAddedValue = s;
                    expressionField.value = lastAddedValue;
                }
            } else {
                if (lastButtonOperator){
                    lastAddedValue = ' ' + s + ' ';
                    expressionField.value = expressionField.value + lastAddedValue;
                } else {
                    lastAddedValue = s;
                    expressionField.value = expressionField.value + lastAddedValue;
                }
            }
            if (consecutiveDots(expressionField.value)) {
                expressionField.value = expressionField.value.substr(0, expressionField.value.length - 1);
            } else {
                operateStack(STACK_ADD, lastAddedValue.length);
            }
            lastButtonEqual = false;
            blurIfAvailable(comp);
        }
    }

    function updateHistory() {
        var historyComponent = $('#history-container');
        $.get(encodeURI('/history?token=' + token)
        ).done(function (historyResponse) {
            historyComponent.text('');
            historyComponent.append(historyResponse.body.tableHTML);
        }).fail(function (failedResponse) {
            displayError(failedResponse.responseJSON.message);
        }).always(function () {
            allowInteractions = true;
        });
    }

    function executeCalculationWithToken(expressionText, expressionField, calculatedToken) {
        $.post(encodeURI('?token=' + calculatedToken + '&expression=' + expressionText)
        ).done(function (calculationResponse) {
            expressionField.value = calculationResponse.body.result;
            lastButtonEqual = true;
            operateStack(STACK_EMPTY);
        }).fail(function (failedResponse) {
            displayError(failedResponse.responseJSON.message);
        }).always(function () {
            updateHistory();
        });
    }

    function calculate() {
        $('#bcalculate').blur();
        if (allowInteractions) {
            allowInteractions = false;
            initExpressionField();
            var expressionText = encodeURIComponent(expressionField.value);
            if (token.length > 0) {
                executeCalculationWithToken(expressionText, expressionField, token);
            } else {
                retrieveSessionToken().then(function (resultToken) {
                    token = resultToken;
                    executeCalculationWithToken(expressionText, expressionField, token);
                }, function () {
                    allowInteractions = true;
                });
            }
        }
    }

    function clearResult() {
        lastButtonEqual = true;
        operateStack(STACK_EMPTY);
        initExpressionField();
        expressionField.value = 0;
        $('#clear_result').blur();
    }

    function displayHistory() {
        if (token.length > 0) {
            var historyComponent = $('#history-container');
            if (historyComponent[0].style.display === 'none') {
                historyComponent[0].style.display = 'block'
            } else {
                historyComponent[0].style.display = 'none'
            }
        }
        $('#display_history').blur();
    }

    function clearExpressionRecord() {
        initExpressionField();
        expressionField.value = '0';
        lastButtonEqual = true;
        operateStack(STACK_EMPTY);

    }

    function howManyDigitsToRemove(value, len) {
        if (value.charAt(0) !== MINUS_SYMBOL) {
            return 1;
        } else {
            if (len > 2) {
                return 1;
            }
            return 2;
        }
    }

    function removeLastCharacter() {
        initExpressionField();
        var expLength = expressionField.value.length;
        if (lastButtonEqual) {
            if (ERROR_RESULTS.indexOf(expressionField.value.toUpperCase()) >= 0) {
                clearExpressionRecord();
            } else {
                expressionField.value = expressionField.value.substr(0, expLength - howManyDigitsToRemove(expressionField.value, expLength));
            }
        } else {
            expressionField.value = expressionField.value.substr(0, expLength - operateStack(STACK_REMOVE));
        }
        if (expressionField.value.length === 0) {
            clearExpressionRecord();
        }
        $('#remove_last').blur();
    }

    function initCalculationPanels() {
        if (panels.length === 0) {
            panels = [$('#main_calculator_panel'), $('#integral_calculator_panel')];
        }
    }
    function evaluateKeyPressed(eventCaptured) {
        initCalculationPanels();
        var code = ('charCode' in eventCaptured) ? eventCaptured.charCode : eventCaptured.keyCode;
        var index = VALID_CODES.indexOf(code);
        if (code === ESC_KEY) {
            clearResult();
        }
        if (activePanel === 0) {
            if (index >= 0) {
                append(this, VALID_KEYS[index], true);
            } else if (code === ENTER_CODE) {
                calculate();
            }
        }
    }

    function toggleBasicIntegralPanels(num) {
        initCalculationPanels();
        if (activePanel !== num) {
            clearExpressionRecord();
            panels[activePanel].fadeOut();
            panels[activePanel][0].style.display = 'none';
            activePanel = num;
            panels[activePanel].fadeIn();
            panels[activePanel][0].style.display = 'block';
        }
    }

    function requestExponentialIntegral() {
        if (allowInteractions) {
            allowInteractions = false;
            initIntegralSubmit();
            initExpressionField();
            integralSubmit.blur();
            if (token.length > 0) {
                executeExponentialIntegralWithToken(token, expressionField);
            } else {
                retrieveSessionToken().then(function (resultToken) {
                    token = resultToken;
                    executeExponentialIntegralWithToken(token, expressionField);
                }, function () {
                    allowInteractions = true;
                });
            }
        }
    }

    function validIntegralRequestData(req) {
        return req.lowerBound <= req.upperBound
                && req.numberThreads > 0 && req.numberThreads <= 15
                && req.repeatedCalculations > 0 && req.repeatedCalculations < 1000000;
    }

    function executeExponentialIntegralWithToken(receivedToken, expressionField) {
        var integralRequest = {
            lowerBound: parseFloat($('#lowerbound')[0].value),
            upperBound: parseFloat($('#upperbound')[0].value),
            repeatedCalculations: parseInt($('#repeatedcalculations')[0].value),
            numberThreads: parseInt($('#numthreads')[0].value),
            functionId: integralSelectedFunction
        };
        if (validIntegralRequestData(integralRequest)){
            $.ajax({
                url : encodeURI('/integral?token=' + receivedToken),
                type: 'POST',
                dataType : "json",
                data:  JSON.stringify(integralRequest),
                headers: {
                    'Content-Type': 'application/json'
                }
            }).fail(function (response) {
                displayError('unable to calculate integral ' + response.messsage);
            }).done(function (integralResponse) {
                console.log(integralResponse.body.description + ' => ' + integralResponse.body.result + ' #' + integralRequest.repeatedCalculations);
                expressionField.value = integralResponse.body.result;
                lastButtonEqual = true;
            }).always(function () {
                updateHistory();
            });
        } else {
            displayError('invalid integral request, please verify the constraints for the fields');
            allowInteractions = true;
        }

    }

    function useFunction(num) {
        $('#selected_function')[0].value = AVAILABLE_FUNCTIONS[num];
        integralSelectedFunction = num;
    }

</script>
<div class="panel panel-default" style="align-content: center;">
    <div class="jumbotron">
        <h1>Web Calculator 1.0</h1>
        <div class="panel-body">
            <div id="all-content">
                <div id="calculator-container">
                    <div class="input-group input-group-lg to-center">
                        <span class="input-group-addon" id="basic-addon1"></span>
                        <input type="text" id="expression"
                               name="expression" class="form-control" placeholder="" aria-describedby="basic-addon1"
                               value="0" style="text-align:right; width: 400px" readonly/>
                        <ul class="nav nav-tabs">
                            <li role="presentation" data-toggle="tab" onclick="toggleBasicIntegralPanels(0)"><a href="#">Basic</a></li>
                            <li role="presentation" data-toggle="tab" onclick="toggleBasicIntegralPanels(1)"><a href="#">Integrals</a></li>
                            <li role="presentation"><a href="#">
                                <button type="button" class="btn btn-info btn-xs" id="display_history" onclick="displayHistory()">History</button>
                            </a></li>
                            <li role="presentation" onclick="clearResult()"><a href="#">
                                <button type="button" class="btn btn-danger btn-xs" id="clear_result">Clear</button>
                            </a></li>
                            <li role="presentation" onclick="removeLastCharacter()" ><a href="#">
                                <button type="button" class="btn btn-warning btn-xs" id="remove_last"><span
                                        class="glyphicon glyphicon-arrow-left"></span></button>
                            </a></li>
                        </ul>
                        <div class="calc-buttons operation-container" id="main_calculator_panel" style="display: block;">
                            <div class="btn-group btn-group-lg">
                                <button type="button" class="btn btn-primary" id="b7" onclick="append(this.id, '7')">7</button>
                                <button type="button" class="btn btn-primary" id="b8" onclick="append(this.id, '8')">8</button>
                                <button type="button" class="btn btn-primary" id="b9" onclick="append(this.id, '9')">9</button>
                                <button type="button" class="btn btn-primary" id="bplus" onclick="append(this.id, '+')">+</button>
                                <button type="button" class="btn btn-primary" id="bleftB" onclick="append(this.id, '[')">[</button>
                                <button type="button" class="btn btn-primary" id="brightB" onclick="append(this.id, ']')">]</button>
                            </div>
                            <div class="btn-group btn-group-lg">
                                <button type="button" class="btn btn-primary" id="b4" onclick="append(this.id, '4')">4</button>
                                <button type="button" class="btn btn-primary" id="b5" onclick="append(this.id, '5')">5</button>
                                <button type="button" class="btn btn-primary" id="b6" onclick="append(this.id, '6')">6</button>
                                <button type="button" class="btn btn-primary" id="bminus" onclick="append(this.id, '-')">-</button>
                                <button type="button" class="btn btn-primary" id="bleftP" onclick="append(this.id, '(')">(</button>
                                <button type="button" class="btn btn-primary" id="brightP" onclick="append(this.id, ')')">)</button>
                            </div>
                            <div class="btn-group btn-group-lg">
                                <button type="button" class="btn btn-primary" id="b1" onclick="append(this.id, '1')">1</button>
                                <button type="button" class="btn btn-primary" id="b2" onclick="append(this.id, '2')">2</button>
                                <button type="button" class="btn btn-primary" id="b3" onclick="append(this.id, '3')">3</button>
                                <button type="button" class="btn btn-primary" id="bmult" onclick="append(this.id, '*')">*</button>
                                <button type="button" class="btn btn-primary" id="bleftC" onclick="append(this.id, '{')">{</button>
                                <button type="button" class="btn btn-primary" id="brightC" onclick="append(this.id, '}')">}</button>
                            </div>
                            <div class="btn-group btn-group-lg">
                                <button type="button" class="btn btn-primary" id="b0" onclick="append(this.id, '0')">0</button>
                                <button type="button" class="btn btn-primary" id="bdot" onclick="append(this.id, '.')">.</button>
                                <button type="button" class="btn btn-primary" id="bcalculate" onclick="calculate()">=</button>
                                <button type="button" class="btn btn-primary" id="bdivide" onclick="append(this.id, '/')">/</button>
                                <button type="button" class="btn btn-primary" id="bsqrt" onclick="append(this.id, 'sqrt (')">sqrt</button>
                            </div>
                        </div>
                        <div class="panel-body" id="integral_calculator_panel" style="display: none">
                            <form id="integralForm" onsubmit="requestExponentialIntegral();return false;">
                                <div class="input-group">
                                    <div class="input-group-btn">
                                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Function<span class="caret"></span></button>
                                        <ul class="dropdown-menu">
                                            <li onclick="useFunction(0)"><a href="#">e^x</a></li>
                                        </ul>
                                    </div><!-- /btn-group -->
                                    <input type="text" id="selected_function" class="form-control" aria-label="..." value="e^x" readonly>
                                </div><!-- /input-group -->
                                <div class="input-group input-group-lg">
                                    <span class="input-group-addon" id="sizing-addon2">Lower Bound:</span>
                                    <input type="number" class="form-control" id="lowerbound" data-toggle="tooltip" data-placement="right" title="must be lower that upper-bound" aria-describedby="sizing-addon2" value="0" step="0.01">
                                </div>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-addon" id="sizing-addon1">Upper Bound:</span>
                                    <input type="number" class="form-control" id="upperbound" data-toggle="tooltip" data-placement="right" title="must be higher than lower-bound" aria-describedby="sizing-addon1" value="0" step="0.01">
                                </div>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-addon" id="sizing-addon3">Repeated Calculations:</span>
                                    <input type="number" class="form-control" id="repeatedcalculations" data-toggle="tooltip" data-placement="right" title="must a be number between [1 and 999999]" aria-describedby="sizing-addon3" min="1" max="999999" value="1">
                                </div>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-addon" id="sizing-addon4">Number Threads:</span>
                                    <input type="number" class="form-control" id="numthreads" data-toggle="tooltip" data-placement="right" title="must be number between [1 and 15]" aria-describedby="sizing-addon4" min="1" max="15" value="1">
                                </div>
                                <div class="btn-group btn-group-lg">
                                    <button type="submit" class="btn btn-primary integral-inputs" id="sendintegral">Evaluate Integral</button>
                                </div>
                            </form>
                        </div>
                        <div id="error_messages" class="error-messages"></div>
                    </div>
                </div>
                <div id="history-container" style="display: none"></div>
            </div>
        </div>
    </div>
    <div class="panel-footer">web calculator 1.0 (Agustin Cabra 2016)</div>
</div>
</body>
</html>
